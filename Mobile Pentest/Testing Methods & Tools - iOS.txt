- due to difference in architecture used in simulators(x86 arch) its required test in a real device (ARM arch)
- .h file is the header file and .m file is the implementation (priority is for .m file)
- debug the apps at runtime requires to jailbreak
- if device is not jailbroken we need to patch the app to insert frida dylib which is complex
- jailbroken device is straightforward
- create provisioning profile and developer account using xcode in a mac

Lab setup in jailbroken iphone
- jailbreak using checkra.in
- cydia - app store for pentesting tools
- download openssh from cydia
- in cydia add another repo in source https://build.frida.re
- install frida server from the above repo - depending on chip install appropriate server

Lab Setup in mac
- require frida client on mac
- install objection on mac- runtime manipulation and more other use cases (local data storage) - github/sensepost/object - add to system if not working properly- frida client automatically installed along with objection
- verify the installed apps
- go to terminal in mac - ssh root@iphoneip -> password = alpine (iphone ip from wifi settings)
- go to terminal in mac - frida-ps -Uai
- go to terminal in mac - type objection -> type objection --gadget "com.apple.mobilemail" explore (starts mail application in iphone)


Provisioning Profile includes signing certificates, device identifiers and bundle ID (embedded.mobileprovisioning) - enables device to be used for testing
- go to general in iphone -> profile and device management ->trust the profile
- obtain the embedded.mobileprovisioning in mac xcode ->products ->open finder ->open package contents

For same developer - methods to embed provisioning profile
- sign the app using embedded.mobileprovisioning - can be done using applesign(npm install -g appliesign) - need to install using brew
commands in terminal
applesign -L (list signing identities available)
applesign -i <id> <app-name> -m embedded.mobileprovisioning

**************************************************************************************Testing*************************************************************************************

Jailbreak Detection Bypass
	Hestia - Tool available in Sileo or Cydia
	Using Objection -> objection --gadget "com.app" explore -s "ios jailbreak disable"
  	can use other methods such as return a value to a method when launching app using objection (identify the method checking for jailbreak and override the value)

SSL Pinning Bypass
	Use SSL Kill Switch Tool
	Use AppSync to trust certificates by default, instead of manually verifying in VPN & Device Management section
	Objection -> ios sslpinning disable

Basic Static Analysis

	PIE (Position Independent Executable): When enabled, the application loads into a random memory address every-time it launches, making it harder to predict its initial memory address.
		otool -hv <app-binary> | grep PIE   # It should include the PIE flag

	Stack Canaries: To validate the integrity of the stack, a ‘canary’ value is placed on the stack before calling a function and is validated again once the function ends.
	otool -I -v <app-binary> | grep stack_chk   # It should include the symbols: stack_chk_guard and stack_chk_fail

	ARC (Automatic Reference Counting): To prevent common memory corruption flaws
		otool -I -v <app-binary> | grep objc_release   # It should include the _objc_release symbol

	Encrypted Binary: The binary should be encrypted
		otool -arch all -Vl <app-binary> | grep -A5 LC_ENCRYPT   # The cryptid should be 1
		otool -l <app-binary> | grep -A 4 LC_ENCRYPTION_INFO

	Alternative tool having GUI is MachOview

Identification of Sensitive/Insecure Functions (can be obtained using MobSF)
	Weak Hashing Algorithms
		# On the iOS device
		otool -Iv <app> | grep -w "_CC_MD5"
		otool -Iv <app> | grep -w "_CC_SHA1"
		# On linux
		grep -iER "_CC_MD5"
		grep -iER "_CC_SHA1"

	Insecure Random Functions
		# On the iOS device
		otool -Iv <app> | grep -w "_random"
		otool -Iv <app> | grep -w "_srand"
		otool -Iv <app> | grep -w "_rand"
		# On linux
		grep -iER "_random"
		grep -iER "_srand"
		grep -iER "_rand"

	Insecure ‘Malloc’ Function
		# On the iOS device
		otool -Iv <app> | grep -w "_malloc"
		# On linux
		grep -iER "_malloc"

	Insecure and Vulnerable Functions
		# On the iOS device
		otool -Iv <app> | grep -w "_gets"
		otool -Iv <app> | grep -w "_memcpy"
		otool -Iv <app> | grep -w "_strncpy"
		otool -Iv <app> | grep -w "_strlen"
		otool -Iv <app> | grep -w "_vsnprintf"
		otool -Iv <app> | grep -w "_sscanf"
		otool -Iv <app> | grep -w "_strtok"
		otool -Iv <app> | grep -w "_alloca"
		otool -Iv <app> | grep -w "_sprintf"
		otool -Iv <app> | grep -w "_printf"
		otool -Iv <app> | grep -w "_vsprintf"
		# On linux
		grep -R "_gets"
		grep -iER "_memcpy"
		grep -iER "_strncpy"
		grep -iER "_strlen"
		grep -iER "_vsnprintf"
		grep -iER "_sscanf"
		grep -iER "_strtok"
		grep -iER "_alloca"
		grep -iER "_sprintf"
		grep -iER "_printf"
		grep -iER "_vsprintf"

Disassembling the binary
	otool -tV <app-binary>

Testing URL Handling and Validation
	application:didFinishLaunchingWithOptions: method or application:will-FinishLaunchingWithOptions:: verify how the decision is made and how the information about the URL is retrieved.
	application:openURL:options:: verify how the resource is being opened, i.e. how the data is being parsed, verify the options, especially if access by the calling app (sourceApplication) should be allowed or denied. The app might also need user permission when using the custom URL scheme.

Testing URL Requests to Other Apps
	egrep -nr "open.*options.*completionHandler" <bundle.app>
	egrep -nr "openURL\(" <bundle.app>
	egrep -nr "mt-encrypted-file://" <bundle.app>
	egrep -nr "://" <bundle.app>

Testing for Deprecated Methods - https://developer.apple.com/documentation/uikit (filter for deprecated)
	rabin2 -zzq File.app/App-binary | grep -i "openurl"

Traffic Analysis
	Setup proxy to 127.0.0.1:8080 -> browser search for burp/
	Download the burp ca certificate -> go to settings and install the profile downloaded in VPN & Device Management
	Utilize burpsuite mobile assistant
		add source url in Sileo/cydia (http://mac-ip:8080)
	using objection -> objection --gadget "com.app" explore -s "ios sslpinning disable"
	use ssl-kill-switch tool as alternative

Insecure Data Storage (/var/mobile/containers/Data/Application)
	get all the folders that specific application utilizes using objection tool (after objection --gadget <com.app> explore> -> env)
	alternative tools are RMS and Grapefruit

  Below files can be found in the application's respective folder (folder name would be UUID)
	Plist Files - xml file that stores key-value pairs 
	NSUserDefaults - similar to Plist files
	SQLite Databases - 
	Core Data - same as SQLite DB
	Keychain - apple's recommended way of storing sensitive on the device (wifi passwords, crypto keys, certificates etc)
	To dump keychain -> download keychain-dumper tool -> ssh into device -> create a folder mkdir /tmp/keychain -> use sftp to push the keychain_dumper file downloaded on mac -> cd /tmp/keychain ->run ./keychain_dumper > keychain.txt (in ssh session)
  Commands used:
	ssh root@<ip>  (pass: alpine)
	find -type d -name <bundle-identifier> (to identify the application folder as it is in UUID name)
	file <any-file> (used to identify type of file)
	use cyberduck to pull files locally
	sqlite3 <db-file> or sqlite <dbfile> (based on output from file command)
	frida-ps -Uai | grep <appname-hint>
	objection --gadget "<com.app>" explore
		Run below commands inside objection session
		env (gives you all the directories related to specific app)
		file cat <filename to view)
		file download <filename to download>
		sqlite connect <db-file.db>
		ios nsuserdefaults get
		ios nsurlcredentialstorage dump
		ios plist cat Info.plist
		ios keychain dump
		ios monitor crypt
		ios info binary
		ios cookies get  (also can use binarycookiesreader tool)
	alternative tools are RMS and Grapefruit

Server Side Vulnerabilities
	similar to api testing
	intercept requests and exploit

Client Side Vulnerabilities

  Business Logic Vuln
	modify the values in local storage files (plist etc) to bypass authorization, escalate privileges etc
  
  Insecure Logging
	logs can be viewed from Xcode -> Device & Simulators -> Open Console
	Check Logs using 3utools

  Sensitive data in pasteboard
	objection --gadget "<com.app>" explore
	  ios pasteboard monitor
	alternative tools are RMS and Grapefruit
	 
  Client Side script injection (caused with the use of WebView) - WebView XSS
	intercept any webview requests and try xss payloads

Decrypt iOS Apps (apps are encrypted using Apple Fairplay DRM)
	Tools : clutch, bfinject, frida-ios-dump
	frida-ios-dump -> git clone -> pip install -r requirements.txt -> nano dump.py (modify iphone's ip, port username & password for ssh) -> python dump.py "com.app"

Dumping Class Information (class-dump tool)
	rename .ipa file to .zip file -> extract -> identify a binary/executable related to app
	run ./class-dump <provide binary/executable identified above>
	ios hooking list classes - (run inside objection)
	ios hooking list class_methods
	alternative tools are RMS and Grapefruit

Runtime-Analysis using Frida

	Commands:
	  frida -U -n "application-name/display-name"
	  frida-trace -U -m "*[NSURLRequest *]" "application-name/displayname" (- denotes instance methods & + denotes class methods)

Runtime Analysis using Objection

	objection --gadget "com.app" explore
	Commands:
		ios hooking watch class "class-name" 
		ios hooking watch method "method-name" --dump-args --dump-return --dump-backtrace
	alternative tools are RMS and Grapefruit

Runtime Analysis using r2frida
	r2 frida://spawn//usb//<buundle-id>
	Commands:
		:i?
		:ic~<String) (search for classes)
		:dtf <memory location of function>

Dumping Heap/Memory using Objection

	objection --gadget "com.app" explore
		memory dump all <file-name>.dmp
	file saved to mac -> view using strings method
	alternative tools are RMS and Grapefruit

Reverse Engineering (Hopper Disassembler, iRET, IDA Free, Ghidra)
	convert the .ipa to .zip file
	identify the binary/executable file -> load it in hopper

Automated Static & Dynamic Analysis using MobSF

		
  



*******************************************************Tools***********************************************************

Quick Time Player - https://support.apple.com/downloads/quicktime
Openssh (user = root pass = alpine), SFTP Server, Filza (File Manager), wget, ps, apt-get, BigBoss Recommended Tools, sqlite3, uzip, dpkg - should be available in palera1in or any other jailbreak but needs to be installed
Sileo Source Url's : build.frida.re, https://cydia.radare.org/, https://cydia.akemi.ai/
Objection : pip3 install objection (contains frida client) - https://github.com/sensepost/objection
Grapefruit : https://github.com/ChiChou/grapefruit
Runtime Mobile Security (RMS) : https://github.com/m0bilesecurity/RMS-Runtime-Mobile-Security
CyberDuck : https://cyberduck.io/ (view files via sftp in Mac)
iMazing : Sideload ipa files to iPhone
Xcode : https://developer.apple.com/download/all/?q=Xcode
keychaindumper - https://github.com/ptoomey3/Keychain-Dumper
MobSf - https://github.com/MobSF/Mobile-Security-Framework-MobSF
BinaryCookiesReader : pip install binarycookiesreader
class-dump - brew install class-dump or http://stevenygard.com/projects/class-dump/(https://www.allysonomalley.com/?s=iOS+Pentesting+Tools)
clutch  - https://github.com/KJCracks/Clutch
radare2 - pull repo in iPhone
Hopper - https://www.hopperapp.com/
iRet - https://github.com/S3Jensen/iRET
IDA Free - https://hex-rays.com/ida-free/
Cycript - part of cydia (ssh into device -> run cycript
frida-ios-dump - https://github.com/AloneMonkey/frida-ios-dump
BFinject - https://github.com/BishopFox/bfinject
iRET - https://www.veracode.com/sites/default/files/Resources/Tools/iRETTool.zip
otool / MachOView -  https://sourceforge.net/projects/machoview/files/
Ssl-Kill-Switch2 - https://github.com/nabla-c0d3/ssl-kill-switch2 
Burpsuite mobile assistant - https://portswigger.net/burp/documentation/desktop/tools/mobile-assistant/installing
Pagestuf - similar to otool
LIEF - https://lief-project.github.io (similar to otool)

